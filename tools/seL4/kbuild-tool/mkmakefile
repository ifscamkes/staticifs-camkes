#!/bin/sh

#
# Copyright 2014, NICTA
#
# This software may be distributed and modified according to the terms of
# the GNU General Public License version 2. Note that NO WARRANTY is provided.
# See "LICENSE_GPLv2.txt" for details.
#
# @TAG(NICTA_GPL)
#

# Generates a small Makefile used in the root of the output
# directory, to allow make to be started from there.
# The Makefile also allow for more convinient build of external modules

# Usage
# $1 - Kernel src directory
# $2 - Output directory
# $3 - makefile name


test ! -r $2/$3 -o -O $2/$3 || exit 0
echo "  GEN     $2/$3"

cat << EOF > $2/$3
# Automatically generated by $0: don't edit

KERNELSRC    := $1
KERNELOUTPUT := $2

.PHONY: all \$(MAKECMDGOALS)

all:
	\$(MAKE) -C \$(KERNELSRC) O=\$(KERNELOUTPUT) -f $3

$5:;

\$(filter-out all $5,\$(MAKECMDGOALS)):
	\$(MAKE) -C \$(KERNELSRC) O=\$(KERNELOUTPUT) \$@ -f $3

%/:
	\$(MAKE) -C \$(KERNELSRC) O=\$(KERNELOUTPUT) \$@ -f $3
EOF
